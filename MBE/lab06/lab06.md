## lab6C

In this lab we are handling tweets once again. We have 4 interesting functions:
	* ```handle_tweet``` - makes calls to the other 2 functions
	* ```set_username``` - as the name implies, asks as to insert a username
	* ```set_tweet``` - as the name implies, asks as to insert a tweet
	* ```secret_backdoor``` - allows us to execute systems() commands, but we can't access it.

The ```handle_tweet``` function is called once, therefore we will only insert one username and one tweet.
The username and tweet are stored in a ```struct```.

```c
struct savestate {
    char tweet[140];
    char username[40];
    int msglen;
} save;
```

When setting the username, we can see that first it will put our input in an array with a call to fgets. It will then go through a for loop and copy byte after byte into our ```save->username```. This is where the flaw comes in:

```c
for(i = 0; i <= 40 && readbuf[i]; i++)
        save->username[i] = readbuf[i];
```

As we can see, it writes one more byte and so will overwrite ```int msglen```, which was set to 140 before. As such, we can set ```msglen``` to any value we want and so we can overflow the ```tweet[140]``` buffer and change the ```ret``` pointer of ```handle_tweet``` to ```secret_backdoor```.

This is our first challenge with ```ASLR``` and ```PIE``` enabled, so you bet that the address are not static at all.

Here are the addresses of the original ```ret``` pointer and the address of ```secret_backdoor```.

```
0xb7757 98a - ret
0xb7757 72b - secret_backdoor
```

Here they are again after being modified in by PIE.

```
0xb7731 98a - ret
0xb7731 72b - secret_backdoor
```

As you can see, the higher ```5 bits``` are the same in both addresses. Therefore, we would only need to modify the last ```3 bits```. Since, at minimum, we can modify one byte at a time, we will have to modify the last ```2 bytes```/```4 bits``` and pray to God that the 4th last bit matches.

In conclusion, we have to perform a ```brute force```. It should work 1 out of 16 times.
Note that we will have to set ```msglen``` accordingly, so that we overwrite only the ```local variables```, ```base pointer``` and 2 bytes off of ```ret```. From the ```struct``` to ```base pointer``` there are ```192 byte``` => ```192 + 4 + 2 = 198 bytes``` => ```msglen``` will be set to ```\xC6.```

```bash
lab6C@warzone:/levels/lab06$ python expl6C.py
--------------------------------------------
|   ~Welcome to l33t-tw33ts ~    v.0.13.37 |
--------------------------------------------
>: Enter your username
>>: >: Welcome, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA: Tweet @Unix-Dude
>>: >: Tweet sent!
/bin/sh
cat ~lab6B/.pass
p4rti4l_0verwr1tes_r_3nuff
```
